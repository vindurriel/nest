// Generated by CoffeeScript 1.6.3
var cacheIt, click, color, draw, expand, getLinkName, getR, highlight, r, redraw, save, tick, update;

cacheIt = function(e) {
  r.ctrlPressed = e.ctrlKey;
  r.altPressed = e.altKey;
  r.shiftPressed = e.shiftKey;
  return true;
};

redraw = function() {
  return r.vis.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
};

draw = function(json) {
  var n;
  r.nodes = json.nodes;
  r.links = json.links;
  r.root = json.nodes[0];
  r.theFocus = r.root;
  r.root.fixed = false;
  r.root.isHigh = true;
  r.force = d3.layout.force().on("tick", tick).charge(function(d) {
    if (d.type === "referData") {
      return -20;
    } else {
      return -200;
    }
  }).linkDistance(20).linkStrength(.1).size([r.w, r.h]).nodes(r.nodes).links(r.links);
  n = r.nodes.length;
  r.nodes.forEach(function(d, i) {
    d.x = i * r.w / n;
    return d.y = i * r.h / n;
  });
  return update();
};

getLinkName = function(source, target) {
  return "" + source.name + "->" + target.name;
};

update = function() {
  var i, j, n, nodeEnter, x, _i, _j, _k, _l, _len, _len1, _ref, _ref1, _results;
  r.link = r.link.data(r.links).classed("highlight", function(d) {
    return d.isHigh === true;
  });
  r.link.enter().insert("line", ".node").classed("link", true);
  r.link.exit().remove();
  r.node.remove();
  r.node = r.vis.selectAll(".node").data(r.nodes, function(d) {
    return d.id;
  }).classed("highlight", function(d) {
    return d.isHigh === true;
  });
  nodeEnter = r.node.enter().append("g").attr("class", "node").on("click", click).classed("highlight", function(d) {
    return d.isHigh === true;
  }).attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")";
  }).call(r.force.drag);
  nodeEnter.append("circle").attr("cx", 0).attr("cy", 0).attr("r", getR).style("fill", color);
  nodeEnter.append("title").text(function(d) {
    return d.name;
  });
  nodeEnter.append("text").attr("class", "notclickable desc").attr("dx", function(d) {
    return getR(d);
  }).text(function(d) {
    if (d.type === "referData") {
      return "";
    }
    return d.name;
  });
  r.node.exit().remove();
  d3.selectAll(".node circle").attr("r", getR).style("fill", color);
  d3.selectAll(".node text").attr("dx", getR).classed("show", function(d) {
    return d === r.theFocus;
  });
  d3.selectAll(".search-img").remove();
  r.node.filter(function(d) {
    return d.isSelected;
  }).append("image").attr("x", function(d) {
    return -1.2 * 32 * getR(d) / 15.0;
  }).attr("y", function(d) {
    return -1.2 * 32 * getR(d) / 15.0;
  }).attr("width", function(d) {
    return 1.2 * 64 * getR(d) / 15.0;
  }).attr("height", function(d) {
    return 1.2 * 64 * getR(d) / 15.0;
  }).attr("xlink:href", "/static/images/loader.gif").classed("search-img", true);
  r.force.start();
  r.matrix = [];
  n = r.nodes.length;
  for (i = _i = 0; 0 <= n ? _i <= n : _i >= n; i = 0 <= n ? ++_i : --_i) {
    r.matrix.push([]);
    for (j = _j = 0; 0 <= n ? _j <= n : _j >= n; j = 0 <= n ? ++_j : --_j) {
      r.matrix[i].push(null);
    }
  }
  _ref = r.nodes;
  for (_k = 0, _len = _ref.length; _k < _len; _k++) {
    x = _ref[_k];
    if (r.hNode[x.name] == null) {
      r.hNode[x.name] = x;
    }
  }
  _ref1 = r.links;
  _results = [];
  for (_l = 0, _len1 = _ref1.length; _l < _len1; _l++) {
    x = _ref1[_l];
    _results.push(r.matrix[x.source.index][x.target.index] = x);
  }
  return _results;
};

getR = function(d) {
  if (d === r.theFocus) {
    return 15;
  }
  if (d.isHigh) {
    return 10;
  } else {
    return 5;
  }
};

tick = function() {
  r.link.attr("x1", function(d) {
    return d.source.x;
  }).attr("y1", function(d) {
    return d.source.y;
  }).attr("x2", function(d) {
    return d.target.x;
  }).attr("y2", function(d) {
    return d.target.y;
  });
  return r.node.attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")";
  });
};

color = function(d) {
  var i;
  i = r.colors.indexOf(d.type);
  if (i >= 0) {
    return r.palette(i + 1);
  }
  return r.palette(0);
};

click = function(d) {
  var i, j, link, n, url, _i;
  if (r.shiftPressed) {
    if (d === r.root) {
      alert("不能删除根节点");
      r.shiftPressed = false;
      return;
    }
    n = r.nodes.length;
    i = d.index;
    for (j = _i = 0; 0 <= n ? _i <= n : _i >= n; j = 0 <= n ? ++_i : --_i) {
      link = r.matrix[i][j];
      if (link != null) {
        r.links.remove(link);
      }
      link = r.matrix[j][i];
      if (link != null) {
        r.links.remove(link);
      }
    }
    r.nodes.splice(i, 1);
    r.hNode[d.name] = void 0;
    blacklist.push(d.name);
  } else if (r.altPressed) {
    save().done(function() {
      return window.location.href = "/model/" + d.name;
    });
    return;
  } else if (r.ctrlPressed) {
    if (d.type === "referData") {
      window.open(d.url != null ? d.url : d.name);
      return;
    }
    if ((d.isSelected != null) && d.isSelected === true) {
      d.isSelected = false;
    } else {
      d.isSelected = true;
    }
    if (!d.isSelected) {
      return;
    }
    url = "/roaming/" + d.type + "s/" + d.id;
    d3.json(url, function(data) {
      return expand(d, data);
    });
  } else {
    highlight(d);
    history.pushState({}, d.name, "/model/" + d.id);
  }
  return update();
};

expand = function(d, data) {
  var i, source, target, x, _i, _len;
  source = r.hNode[d.name];
  if (source == null) {
    return;
  }
  i = 0;
  for (_i = 0, _len = data.length; _i < _len; _i++) {
    x = data[_i];
    if (r.blacklist.indexOf(x.name) >= 0) {
      continue;
    }
    if (x.type === "referData") {
      if (r.hNode[x.name] == null) {
        r.nodes.push(x);
        r.links.push({
          "source": source,
          "target": x
        });
      }
    } else {
      target = x;
      if (r.hNode[x.name] == null) {
        if (i === 5) {
          continue;
        }
        r.nodes.push(x);
        i += 1;
      } else {
        target = r.hNode[x.name];
      }
      if (r.matrix[source.index][target.index] == null) {
        r.links.push({
          "source": source,
          "target": target
        });
      }
    }
  }
  d.isSelected = false;
  return update();
};

highlight = function(d) {
  var i, j, x, _i, _j, _k, _len, _len1, _ref, _ref1, _ref2;
  _ref = r.links;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    x = _ref[_i];
    x.isHigh = false;
  }
  _ref1 = r.nodes;
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    x = _ref1[_j];
    x.isHigh = false;
  }
  d.isHigh = true;
  r.theFocus = d;
  i = d.index;
  for (j = _k = 0, _ref2 = r.nodes.length; 0 <= _ref2 ? _k <= _ref2 : _k >= _ref2; j = 0 <= _ref2 ? ++_k : --_k) {
    if (r.matrix[i][j] != null) {
      r.matrix[i][j].isHigh = true;
      r.nodes[j].isHigh = true;
    }
    if (r.matrix[j][i] != null) {
      r.matrix[j][i].isHigh = true;
      r.nodes[j].isHigh = true;
    }
  }
};

save = function() {
  var res, x, _i, _j, _len, _len1, _ref, _ref1;
  res = {
    "id": r.root.id,
    "name": r.root.name,
    "type": r.root.type,
    "nodes": [],
    "links": []
  };
  _ref = r.nodes;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    x = _ref[_i];
    res.nodes.push({
      "id": x.id,
      "name": x.name,
      "value": x.value,
      "index": x.index,
      "type": x.type,
      "url": x.url
    });
  }
  _ref1 = r.links;
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    x = _ref1[_j];
    res.links.push({
      "name": x.name,
      "source": x.source.index,
      "target": x.target.index
    });
  }
  res = JSON.stringify(res);
  return $.ajax({
    "url": "/model",
    "type": "POST",
    "contentType": "json",
    "data": res
  });
};

r = typeof exports !== "undefined" && exports !== null ? exports : this;

r.hNode = {};

r.w = $(this).width();

r.h = $(this).height();

r.ctrlPressed = false;

r.altPressed = false;

r.shiftPressed = false;

r.blacklist = [];

Array.prototype.remove = function(b) {
  var a;
  a = this.indexOf(b);
  if (a >= 0) {
    this.splice(a, 1);
    return true;
  }
  return false;
};

r.vis = d3.select("#container").append("svg:svg").attr("width", r.w).attr("height", r.h).attr("viewBox", "0 0 " + r.w + " " + r.h).attr("pointer-events", "all").attr("preserveAspectRatio", "XMidYMid").append("svg:g").call(d3.behavior.zoom().on("zoom", redraw)).append("svg:g");

r.link = r.vis.selectAll(".link");

r.node = r.vis.selectAll(".node");

$(document).ready(function() {
  $(document).keydown(cacheIt);
  $(document).keyup(cacheIt);
  $("#btn_tip").click(function() {
    return $("#tip").slideToggle(200);
  });
  $("#btn_save").click(function() {
    return save().done(function() {
      return alert("保存完成");
    }).fail(function(d, e) {
      return alert(e);
    });
  });
  $("#btn_search").click(function() {
    var query, type;
    type = $("input[name='music_type']:checked").val();
    query = $("#q").val();
    if (parseInt(query) === NaN) {
      return;
    }
    return $.getJSON("/model/load/" + query, function(d) {
      if (!d || (d.error != null)) {
        return $.getJSON("/info/" + type + "s/" + query, function(d) {
          if (!d || (d.error != null)) {
            alert(d.error);
            return;
          }
          return draw(d);
        });
      } else {
        return draw(d);
      }
    });
  });
  return $.getJSON("/model/load/" + document.title, function(d) {
    if (!d || (d.error != null)) {
      return draw({
        "nodes": [
          {
            "name": "Everybody",
            "id": "1769077491",
            "type": "song"
          }
        ],
        "links": []
      });
    } else {
      return draw(d);
    }
  });
});

r.vis.append("svg:rect").attr("width", r.w).attr("height", r.h).attr("fill", "none");

r.palette = d3.scale.category10();

r.colors = ["baiduBaikeCrawler", "hudongBaikeCrawler", "referData", "song", "artist", "user", "album"];
